<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 850 550">
  <defs>
    <marker id="arrowPM" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#4b5563"/>
    </marker>
    <marker id="arrowRed" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#ef4444"/>
    </marker>
    <marker id="arrowBlue" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#3b82f6"/>
    </marker>
    <linearGradient id="sagaGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#8b5cf6;stop-opacity:1"/>
      <stop offset="100%" style="stop-color:#7c3aed;stop-opacity:1"/>
    </linearGradient>
  </defs>

  <!-- Title -->
  <text x="425" y="30" font-family="system-ui, sans-serif" font-size="20" font-weight="bold" text-anchor="middle" fill="#1f2937">Process Manager (Saga) Flow</text>
  <text x="425" y="50" font-family="system-ui, sans-serif" font-size="12" text-anchor="middle" fill="#6b7280">Coordinate long-running business processes with compensation</text>

  <!-- Happy Path -->
  <rect x="30" y="70" width="790" height="200" rx="10" fill="#f0fdf4" stroke="#10b981" stroke-width="1.5"/>
  <text x="50" y="95" font-family="system-ui, sans-serif" font-size="12" font-weight="bold" fill="#166534">Happy Path (Order Fulfillment)</text>

  <!-- Events row -->
  <rect x="50" y="115" width="100" height="40" rx="5" fill="#dcfce7" stroke="#10b981"/>
  <text x="100" y="140" font-family="system-ui, sans-serif" font-size="9" text-anchor="middle" fill="#166534">OrderPlaced</text>

  <rect x="200" y="115" width="100" height="40" rx="5" fill="#dcfce7" stroke="#10b981"/>
  <text x="250" y="140" font-family="system-ui, sans-serif" font-size="9" text-anchor="middle" fill="#166534">PaymentReceived</text>

  <rect x="350" y="115" width="100" height="40" rx="5" fill="#dcfce7" stroke="#10b981"/>
  <text x="400" y="140" font-family="system-ui, sans-serif" font-size="9" text-anchor="middle" fill="#166534">InventoryReserved</text>

  <rect x="500" y="115" width="100" height="40" rx="5" fill="#dcfce7" stroke="#10b981"/>
  <text x="550" y="140" font-family="system-ui, sans-serif" font-size="9" text-anchor="middle" fill="#166534">ItemShipped</text>

  <rect x="650" y="115" width="100" height="40" rx="5" fill="#dcfce7" stroke="#10b981"/>
  <text x="700" y="140" font-family="system-ui, sans-serif" font-size="9" text-anchor="middle" fill="#166534">OrderCompleted</text>

  <!-- Arrows between events -->
  <line x1="150" y1="135" x2="200" y2="135" stroke="#10b981" stroke-width="2" marker-end="url(#arrowPM)"/>
  <line x1="300" y1="135" x2="350" y2="135" stroke="#10b981" stroke-width="2" marker-end="url(#arrowPM)"/>
  <line x1="450" y1="135" x2="500" y2="135" stroke="#10b981" stroke-width="2" marker-end="url(#arrowPM)"/>
  <line x1="600" y1="135" x2="650" y2="135" stroke="#10b981" stroke-width="2" marker-end="url(#arrowPM)"/>

  <!-- Commands dispatched -->
  <rect x="150" y="175" width="100" height="30" rx="3" fill="#dbeafe" stroke="#3b82f6"/>
  <text x="200" y="195" font-family="system-ui, sans-serif" font-size="8" text-anchor="middle" fill="#1e40af">ProcessPayment</text>
  <line x1="100" y1="155" x2="150" y2="180" stroke="#3b82f6" stroke-width="1" stroke-dasharray="4,2"/>

  <rect x="300" y="175" width="100" height="30" rx="3" fill="#dbeafe" stroke="#3b82f6"/>
  <text x="350" y="195" font-family="system-ui, sans-serif" font-size="8" text-anchor="middle" fill="#1e40af">ReserveInventory</text>
  <line x1="250" y1="155" x2="300" y2="180" stroke="#3b82f6" stroke-width="1" stroke-dasharray="4,2"/>

  <rect x="450" y="175" width="100" height="30" rx="3" fill="#dbeafe" stroke="#3b82f6"/>
  <text x="500" y="195" font-family="system-ui, sans-serif" font-size="8" text-anchor="middle" fill="#1e40af">ShipItem</text>
  <line x1="400" y1="155" x2="450" y2="180" stroke="#3b82f6" stroke-width="1" stroke-dasharray="4,2"/>

  <rect x="600" y="175" width="100" height="30" rx="3" fill="#dbeafe" stroke="#3b82f6"/>
  <text x="650" y="195" font-family="system-ui, sans-serif" font-size="8" text-anchor="middle" fill="#1e40af">CompleteOrder</text>
  <line x1="550" y1="155" x2="600" y2="180" stroke="#3b82f6" stroke-width="1" stroke-dasharray="4,2"/>

  <!-- Process Manager state -->
  <rect x="720" y="175" width="80" height="70" rx="5" fill="url(#sagaGrad)"/>
  <text x="760" y="200" font-family="system-ui, sans-serif" font-size="9" font-weight="bold" text-anchor="middle" fill="white">PM State</text>
  <text x="760" y="218" font-family="system-ui, sans-serif" font-size="7" text-anchor="middle" fill="#ddd6fe">order_id</text>
  <text x="760" y="232" font-family="system-ui, sans-serif" font-size="7" text-anchor="middle" fill="#ddd6fe">status</text>

  <!-- Failure Path -->
  <rect x="30" y="285" width="790" height="150" rx="10" fill="#fef2f2" stroke="#ef4444" stroke-width="1.5"/>
  <text x="50" y="310" font-family="system-ui, sans-serif" font-size="12" font-weight="bold" fill="#991b1b">Compensation Path (Inventory Unavailable)</text>

  <!-- Failure event -->
  <rect x="350" y="330" width="120" height="40" rx="5" fill="#fecaca" stroke="#ef4444"/>
  <text x="410" y="355" font-family="system-ui, sans-serif" font-size="9" text-anchor="middle" fill="#991b1b">ReservationFailed</text>

  <!-- Compensation commands -->
  <rect x="200" y="385" width="110" height="30" rx="3" fill="#fee2e2" stroke="#ef4444"/>
  <text x="255" y="405" font-family="system-ui, sans-serif" font-size="8" text-anchor="middle" fill="#991b1b">RefundPayment</text>

  <rect x="350" y="385" width="110" height="30" rx="3" fill="#fee2e2" stroke="#ef4444"/>
  <text x="405" y="405" font-family="system-ui, sans-serif" font-size="8" text-anchor="middle" fill="#991b1b">CancelOrder</text>

  <rect x="500" y="385" width="110" height="30" rx="3" fill="#fee2e2" stroke="#ef4444"/>
  <text x="555" y="405" font-family="system-ui, sans-serif" font-size="8" text-anchor="middle" fill="#991b1b">NotifyCustomer</text>

  <!-- Compensation arrows -->
  <line x1="410" y1="370" x2="310" y2="385" stroke="#ef4444" stroke-width="1.5" marker-end="url(#arrowRed)"/>
  <line x1="410" y1="370" x2="405" y2="385" stroke="#ef4444" stroke-width="1.5" marker-end="url(#arrowRed)"/>
  <line x1="410" y1="370" x2="500" y2="385" stroke="#ef4444" stroke-width="1.5" marker-end="url(#arrowRed)"/>

  <!-- Correlation -->
  <rect x="650" y="330" width="150" height="75" rx="5" fill="url(#sagaGrad)"/>
  <text x="725" y="355" font-family="system-ui, sans-serif" font-size="9" font-weight="bold" text-anchor="middle" fill="white">correlate/2</text>
  <text x="725" y="375" font-family="system-ui, sans-serif" font-size="7" text-anchor="middle" fill="#ddd6fe">{continue, OrderId}</text>
  <text x="725" y="390" font-family="system-ui, sans-serif" font-size="7" text-anchor="middle" fill="#ddd6fe">Routes event to</text>
  <text x="725" y="402" font-family="system-ui, sans-serif" font-size="7" text-anchor="middle" fill="#ddd6fe">correct PM instance</text>

  <!-- Callbacks section -->
  <rect x="30" y="450" width="790" height="85" rx="10" fill="#eff6ff" stroke="#3b82f6" stroke-width="1.5"/>
  <text x="50" y="475" font-family="system-ui, sans-serif" font-size="11" font-weight="bold" fill="#1e40af">Key Callbacks</text>

  <rect x="50" y="490" width="170" height="35" rx="3" fill="white" stroke="#3b82f6"/>
  <text x="135" y="512" font-family="system-ui, sans-serif" font-size="8" text-anchor="middle" fill="#1e40af">interested_in() -> [EventType]</text>

  <rect x="240" y="490" width="170" height="35" rx="3" fill="white" stroke="#3b82f6"/>
  <text x="325" y="512" font-family="system-ui, sans-serif" font-size="8" text-anchor="middle" fill="#1e40af">correlate(Event) -> {Mode, Id}</text>

  <rect x="430" y="490" width="170" height="35" rx="3" fill="white" stroke="#3b82f6"/>
  <text x="515" y="512" font-family="system-ui, sans-serif" font-size="8" text-anchor="middle" fill="#1e40af">handle(State, Event) -> Cmds</text>

  <rect x="620" y="490" width="180" height="35" rx="3" fill="white" stroke="#ef4444"/>
  <text x="710" y="512" font-family="system-ui, sans-serif" font-size="8" text-anchor="middle" fill="#991b1b">compensate(State, Failed) -> Cmds</text>
</svg>
