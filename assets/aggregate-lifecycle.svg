<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 550">
  <defs>
    <marker id="arrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#4b5563"/>
    </marker>
    <marker id="arrowBlue" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#3b82f6"/>
    </marker>
    <linearGradient id="stateGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#3b82f6;stop-opacity:1"/>
      <stop offset="100%" style="stop-color:#1d4ed8;stop-opacity:1"/>
    </linearGradient>
    <linearGradient id="hibernateGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#f59e0b;stop-opacity:1"/>
      <stop offset="100%" style="stop-color:#d97706;stop-opacity:1"/>
    </linearGradient>
    <linearGradient id="passiveGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#6b7280;stop-opacity:1"/>
      <stop offset="100%" style="stop-color:#4b5563;stop-opacity:1"/>
    </linearGradient>
  </defs>

  <!-- Title -->
  <text x="400" y="30" font-family="system-ui, sans-serif" font-size="20" font-weight="bold" text-anchor="middle" fill="#1f2937">Aggregate Lifecycle</text>
  <text x="400" y="50" font-family="system-ui, sans-serif" font-size="12" text-anchor="middle" fill="#6b7280">From command to state update with TTL management</text>

  <!-- Timeline bar -->
  <rect x="50" y="75" width="700" height="8" rx="4" fill="#e5e7eb"/>
  <text x="100" y="100" font-family="system-ui, sans-serif" font-size="9" fill="#6b7280">time</text>
  <line x1="720" y1="79" x2="750" y2="79" stroke="#9ca3af" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- State: Not Started -->
  <circle cx="80" cy="150" r="30" fill="#f3f4f6" stroke="#9ca3af" stroke-width="2"/>
  <text x="80" y="155" font-family="system-ui, sans-serif" font-size="10" text-anchor="middle" fill="#4b5563">idle</text>

  <!-- Command arrives -->
  <rect x="130" y="120" width="80" height="25" rx="3" fill="#dbeafe" stroke="#3b82f6"/>
  <text x="170" y="137" font-family="system-ui, sans-serif" font-size="9" text-anchor="middle" fill="#1e40af">Command</text>
  <line x1="110" y1="150" x2="130" y2="135" stroke="#3b82f6" stroke-width="1.5" marker-end="url(#arrowBlue)"/>

  <!-- State: Initializing -->
  <rect x="230" y="120" width="100" height="60" rx="5" fill="url(#stateGrad)"/>
  <text x="280" y="145" font-family="system-ui, sans-serif" font-size="11" font-weight="bold" text-anchor="middle" fill="white">init/1</text>
  <text x="280" y="162" font-family="system-ui, sans-serif" font-size="8" text-anchor="middle" fill="#bfdbfe">Load snapshot</text>
  <text x="280" y="174" font-family="system-ui, sans-serif" font-size="8" text-anchor="middle" fill="#bfdbfe">Replay events</text>

  <line x1="210" y1="132" x2="230" y2="140" stroke="#4b5563" stroke-width="1.5" marker-end="url(#arrow)"/>

  <!-- State: Executing -->
  <rect x="360" y="120" width="100" height="60" rx="5" fill="url(#stateGrad)"/>
  <text x="410" y="145" font-family="system-ui, sans-serif" font-size="11" font-weight="bold" text-anchor="middle" fill="white">execute/2</text>
  <text x="410" y="162" font-family="system-ui, sans-serif" font-size="8" text-anchor="middle" fill="#bfdbfe">Validate command</text>
  <text x="410" y="174" font-family="system-ui, sans-serif" font-size="8" text-anchor="middle" fill="#bfdbfe">Produce events</text>

  <line x1="330" y1="150" x2="360" y2="150" stroke="#4b5563" stroke-width="1.5" marker-end="url(#arrow)"/>

  <!-- State: Applying -->
  <rect x="490" y="120" width="100" height="60" rx="5" fill="url(#stateGrad)"/>
  <text x="540" y="145" font-family="system-ui, sans-serif" font-size="11" font-weight="bold" text-anchor="middle" fill="white">apply/2</text>
  <text x="540" y="162" font-family="system-ui, sans-serif" font-size="8" text-anchor="middle" fill="#bfdbfe">Update state</text>
  <text x="540" y="174" font-family="system-ui, sans-serif" font-size="8" text-anchor="middle" fill="#bfdbfe">per event</text>

  <line x1="460" y1="150" x2="490" y2="150" stroke="#4b5563" stroke-width="1.5" marker-end="url(#arrow)"/>

  <!-- Events persisted -->
  <rect x="415" y="200" width="90" height="25" rx="3" fill="#dcfce7" stroke="#10b981"/>
  <text x="460" y="217" font-family="system-ui, sans-serif" font-size="9" text-anchor="middle" fill="#166534">Events saved</text>
  <line x1="460" y1="180" x2="460" y2="200" stroke="#10b981" stroke-width="1.5"/>

  <!-- State: Active (waiting) -->
  <rect x="620" y="120" width="100" height="60" rx="5" fill="url(#stateGrad)"/>
  <text x="670" y="145" font-family="system-ui, sans-serif" font-size="11" font-weight="bold" text-anchor="middle" fill="white">Active</text>
  <text x="670" y="162" font-family="system-ui, sans-serif" font-size="8" text-anchor="middle" fill="#bfdbfe">In memory</text>
  <text x="670" y="174" font-family="system-ui, sans-serif" font-size="8" text-anchor="middle" fill="#bfdbfe">TTL countdown</text>

  <line x1="590" y1="150" x2="620" y2="150" stroke="#4b5563" stroke-width="1.5" marker-end="url(#arrow)"/>

  <!-- TTL Section -->
  <rect x="50" y="250" width="700" height="130" rx="10" fill="#fefce8" stroke="#eab308" stroke-width="1.5"/>
  <text x="70" y="275" font-family="system-ui, sans-serif" font-size="12" font-weight="bold" fill="#854d0e">Lifespan Management (evoq_aggregate_lifespan)</text>

  <!-- TTL Timer -->
  <rect x="80" y="295" width="150" height="70" rx="5" fill="white" stroke="#d97706"/>
  <text x="155" y="318" font-family="system-ui, sans-serif" font-size="10" font-weight="bold" text-anchor="middle" fill="#92400e">Default TTL: 30min</text>
  <text x="155" y="335" font-family="system-ui, sans-serif" font-size="8" text-anchor="middle" fill="#b45309">after_event/1</text>
  <text x="155" y="350" font-family="system-ui, sans-serif" font-size="8" text-anchor="middle" fill="#b45309">after_command/1</text>

  <!-- Memory Pressure -->
  <rect x="260" y="295" width="150" height="70" rx="5" fill="white" stroke="#d97706"/>
  <text x="335" y="318" font-family="system-ui, sans-serif" font-size="10" font-weight="bold" text-anchor="middle" fill="#92400e">Memory Pressure</text>
  <text x="335" y="335" font-family="system-ui, sans-serif" font-size="8" text-anchor="middle" fill="#b45309">Normal: 1.0x TTL</text>
  <text x="335" y="350" font-family="system-ui, sans-serif" font-size="8" text-anchor="middle" fill="#b45309">Critical: 0.1x TTL</text>

  <!-- Hibernate -->
  <rect x="440" y="295" width="130" height="70" rx="5" fill="url(#hibernateGrad)"/>
  <text x="505" y="320" font-family="system-ui, sans-serif" font-size="10" font-weight="bold" text-anchor="middle" fill="white">Hibernate</text>
  <text x="505" y="338" font-family="system-ui, sans-serif" font-size="8" text-anchor="middle" fill="#fef3c7">After 1min idle</text>
  <text x="505" y="352" font-family="system-ui, sans-serif" font-size="8" text-anchor="middle" fill="#fef3c7">GC + reduce heap</text>

  <!-- Passivate -->
  <rect x="600" y="295" width="130" height="70" rx="5" fill="url(#passiveGrad)"/>
  <text x="665" y="320" font-family="system-ui, sans-serif" font-size="10" font-weight="bold" text-anchor="middle" fill="white">Passivate</text>
  <text x="665" y="338" font-family="system-ui, sans-serif" font-size="8" text-anchor="middle" fill="#d1d5db">Save snapshot</text>
  <text x="665" y="352" font-family="system-ui, sans-serif" font-size="8" text-anchor="middle" fill="#d1d5db">Stop process</text>

  <line x1="230" y1="330" x2="260" y2="330" stroke="#4b5563" stroke-width="1.5" marker-end="url(#arrow)"/>
  <line x1="410" y1="330" x2="440" y2="330" stroke="#4b5563" stroke-width="1.5" marker-end="url(#arrow)"/>
  <line x1="570" y1="330" x2="600" y2="330" stroke="#4b5563" stroke-width="1.5" marker-end="url(#arrow)"/>

  <!-- Reactivation arrow -->
  <path d="M 665 365 L 665 410 L 280 410 L 280 190" fill="none" stroke="#3b82f6" stroke-width="2" stroke-dasharray="5,3" marker-end="url(#arrowBlue)"/>
  <text x="450" y="425" font-family="system-ui, sans-serif" font-size="9" fill="#3b82f6">New command reactivates (init from snapshot + replay)</text>

  <!-- Snapshot indicator -->
  <rect x="50" y="440" width="700" height="90" rx="10" fill="#f0fdf4" stroke="#10b981" stroke-width="1.5"/>
  <text x="70" y="465" font-family="system-ui, sans-serif" font-size="12" font-weight="bold" fill="#166534">Snapshotting Strategy</text>

  <rect x="80" y="480" width="180" height="35" rx="3" fill="white" stroke="#10b981"/>
  <text x="170" y="502" font-family="system-ui, sans-serif" font-size="9" text-anchor="middle" fill="#166534">Every N events (default: 100)</text>

  <rect x="280" y="480" width="180" height="35" rx="3" fill="white" stroke="#10b981"/>
  <text x="370" y="502" font-family="system-ui, sans-serif" font-size="9" text-anchor="middle" fill="#166534">On passivation (TTL expired)</text>

  <rect x="480" y="480" width="180" height="35" rx="3" fill="white" stroke="#10b981"/>
  <text x="570" y="502" font-family="system-ui, sans-serif" font-size="9" text-anchor="middle" fill="#166534">Explicit snapshot(State)</text>
</svg>
