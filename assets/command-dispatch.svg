<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 850 400">
  <defs>
    <marker id="arrowCmd" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#4b5563"/>
    </marker>
    <linearGradient id="cmdGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#3b82f6;stop-opacity:1"/>
      <stop offset="100%" style="stop-color:#1d4ed8;stop-opacity:1"/>
    </linearGradient>
    <linearGradient id="middlewareGrad" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#f3f4f6;stop-opacity:1"/>
      <stop offset="100%" style="stop-color:#e5e7eb;stop-opacity:1"/>
    </linearGradient>
  </defs>

  <!-- Title -->
  <text x="425" y="30" font-family="system-ui, sans-serif" font-size="20" font-weight="bold" text-anchor="middle" fill="#1f2937">Command Dispatch Pipeline</text>
  <text x="425" y="50" font-family="system-ui, sans-serif" font-size="12" text-anchor="middle" fill="#6b7280">Middleware-based command processing with pluggable stages</text>

  <!-- Client -->
  <rect x="30" y="100" width="100" height="50" rx="5" fill="#e5e7eb" stroke="#6b7280" stroke-width="1.5"/>
  <text x="80" y="130" font-family="system-ui, sans-serif" font-size="11" text-anchor="middle" fill="#374151">Client</text>

  <!-- Command -->
  <rect x="155" y="100" width="120" height="50" rx="5" fill="url(#cmdGrad)"/>
  <text x="215" y="122" font-family="system-ui, sans-serif" font-size="10" font-weight="bold" text-anchor="middle" fill="white">evoq_command</text>
  <text x="215" y="138" font-family="system-ui, sans-serif" font-size="7" text-anchor="middle" fill="#bfdbfe">type, target, payload</text>

  <line x1="130" y1="125" x2="155" y2="125" stroke="#4b5563" stroke-width="2" marker-end="url(#arrowCmd)"/>

  <!-- Dispatcher -->
  <rect x="300" y="85" width="120" height="80" rx="5" fill="url(#cmdGrad)"/>
  <text x="360" y="115" font-family="system-ui, sans-serif" font-size="11" font-weight="bold" text-anchor="middle" fill="white">evoq_dispatcher</text>
  <text x="360" y="135" font-family="system-ui, sans-serif" font-size="8" text-anchor="middle" fill="#bfdbfe">Routes command</text>
  <text x="360" y="150" font-family="system-ui, sans-serif" font-size="8" text-anchor="middle" fill="#bfdbfe">to aggregate</text>

  <line x1="275" y1="125" x2="300" y2="125" stroke="#4b5563" stroke-width="2" marker-end="url(#arrowCmd)"/>

  <!-- Middleware Pipeline -->
  <rect x="30" y="190" width="390" height="100" rx="10" fill="url(#middlewareGrad)" stroke="#9ca3af" stroke-width="1.5"/>
  <text x="225" y="215" font-family="system-ui, sans-serif" font-size="11" font-weight="bold" text-anchor="middle" fill="#374151">Middleware Pipeline (evoq_middleware)</text>

  <!-- Middleware boxes -->
  <rect x="50" y="235" width="85" height="40" rx="3" fill="white" stroke="#3b82f6"/>
  <text x="92" y="252" font-family="system-ui, sans-serif" font-size="8" font-weight="bold" text-anchor="middle" fill="#1e40af">Validation</text>
  <text x="92" y="265" font-family="system-ui, sans-serif" font-size="6" text-anchor="middle" fill="#6b7280">Schema check</text>

  <rect x="145" y="235" width="85" height="40" rx="3" fill="white" stroke="#3b82f6"/>
  <text x="187" y="252" font-family="system-ui, sans-serif" font-size="8" font-weight="bold" text-anchor="middle" fill="#1e40af">Idempotency</text>
  <text x="187" y="265" font-family="system-ui, sans-serif" font-size="6" text-anchor="middle" fill="#6b7280">Dedup check</text>

  <rect x="240" y="235" width="85" height="40" rx="3" fill="white" stroke="#3b82f6"/>
  <text x="282" y="252" font-family="system-ui, sans-serif" font-size="8" font-weight="bold" text-anchor="middle" fill="#1e40af">Consistency</text>
  <text x="282" y="265" font-family="system-ui, sans-serif" font-size="6" text-anchor="middle" fill="#6b7280">Strong/eventual</text>

  <rect x="335" y="235" width="75" height="40" rx="3" fill="white" stroke="#6b7280" stroke-dasharray="4,2"/>
  <text x="372" y="258" font-family="system-ui, sans-serif" font-size="8" text-anchor="middle" fill="#6b7280">Custom...</text>

  <!-- Arrows between middleware -->
  <line x1="135" y1="255" x2="145" y2="255" stroke="#3b82f6" stroke-width="1.5" marker-end="url(#arrowCmd)"/>
  <line x1="230" y1="255" x2="240" y2="255" stroke="#3b82f6" stroke-width="1.5" marker-end="url(#arrowCmd)"/>
  <line x1="325" y1="255" x2="335" y2="255" stroke="#6b7280" stroke-width="1.5" stroke-dasharray="4,2"/>

  <!-- Arrow from dispatcher to pipeline -->
  <path d="M 360 165 L 360 180 L 225 180 L 225 190" fill="none" stroke="#4b5563" stroke-width="2" marker-end="url(#arrowCmd)"/>

  <!-- Aggregate -->
  <rect x="450" y="195" width="150" height="90" rx="5" fill="url(#cmdGrad)"/>
  <text x="525" y="225" font-family="system-ui, sans-serif" font-size="11" font-weight="bold" text-anchor="middle" fill="white">evoq_aggregate</text>
  <text x="525" y="245" font-family="system-ui, sans-serif" font-size="8" text-anchor="middle" fill="#bfdbfe">execute(State, Cmd)</text>
  <text x="525" y="260" font-family="system-ui, sans-serif" font-size="8" text-anchor="middle" fill="#bfdbfe">-> {ok, Events}</text>
  <text x="525" y="275" font-family="system-ui, sans-serif" font-size="8" text-anchor="middle" fill="#bfdbfe">apply(State, Event)</text>

  <line x1="420" y1="240" x2="450" y2="240" stroke="#4b5563" stroke-width="2" marker-end="url(#arrowCmd)"/>

  <!-- Event Store -->
  <rect x="630" y="195" width="120" height="90" rx="5" fill="#8b5cf6" stroke="#7c3aed" stroke-width="2"/>
  <text x="690" y="230" font-family="system-ui, sans-serif" font-size="11" font-weight="bold" text-anchor="middle" fill="white">reckon-db</text>
  <text x="690" y="250" font-family="system-ui, sans-serif" font-size="8" text-anchor="middle" fill="#ddd6fe">Persist events</text>
  <text x="690" y="268" font-family="system-ui, sans-serif" font-size="8" text-anchor="middle" fill="#ddd6fe">with version</text>

  <line x1="600" y1="240" x2="630" y2="240" stroke="#4b5563" stroke-width="2" marker-end="url(#arrowCmd)"/>

  <!-- Result -->
  <rect x="780" y="205" width="50" height="70" rx="5" fill="#dcfce7" stroke="#10b981" stroke-width="2"/>
  <text x="805" y="240" font-family="system-ui, sans-serif" font-size="9" font-weight="bold" text-anchor="middle" fill="#166534">ok</text>
  <text x="805" y="258" font-family="system-ui, sans-serif" font-size="7" text-anchor="middle" fill="#166534">Version</text>
  <text x="805" y="270" font-family="system-ui, sans-serif" font-size="7" text-anchor="middle" fill="#166534">Events</text>

  <line x1="750" y1="240" x2="780" y2="240" stroke="#10b981" stroke-width="2" marker-end="url(#arrowCmd)"/>

  <!-- Middleware callbacks -->
  <rect x="450" y="310" width="380" height="70" rx="5" fill="#fef3c7" stroke="#f59e0b"/>
  <text x="640" y="335" font-family="system-ui, sans-serif" font-size="10" font-weight="bold" text-anchor="middle" fill="#92400e">Middleware Callbacks</text>
  <text x="520" y="360" font-family="system-ui, sans-serif" font-size="8" fill="#78350f">before_dispatch(Pipeline) -> {ok, Pipeline}</text>
  <text x="716" y="360" font-family="system-ui, sans-serif" font-size="8" fill="#78350f">after_dispatch(Pipeline) -> {ok, Pipeline}</text>
  <text x="640" y="375" font-family="system-ui, sans-serif" font-size="8" fill="#78350f">on_failure(Pipeline, Reason) -> {ok, Pipeline} | {error, Reason}</text>

  <!-- Error path -->
  <rect x="30" y="310" width="170" height="70" rx="5" fill="#fef2f2" stroke="#ef4444"/>
  <text x="115" y="335" font-family="system-ui, sans-serif" font-size="10" font-weight="bold" text-anchor="middle" fill="#991b1b">Error Handling</text>
  <text x="115" y="355" font-family="system-ui, sans-serif" font-size="8" text-anchor="middle" fill="#7f1d1d">Middleware can reject</text>
  <text x="115" y="370" font-family="system-ui, sans-serif" font-size="8" text-anchor="middle" fill="#7f1d1d">Early return on failure</text>
</svg>
